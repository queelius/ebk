<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - EBK Library</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .stats {
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        /* Search and Filters */
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .search-box {
            width: 100%;
            padding: 12px 20px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }
        .search-box:focus {
            outline: none;
            border-color: #3498db;
        }
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .filter-group label {
            font-size: 14px;
            color: #666;
        }
        .filter-select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .view-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .view-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        /* Navigation */
        .navigation {
            margin-bottom: 20px;
        }
        .tag {
            display: inline-block;
            margin: 5px;
            padding: 8px 16px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-decoration: none;
            color: #333;
            transition: all 0.3s;
            font-size: 14px;
        }
        .tag:hover {
            background: #3498db;
            color: white;
            border-color: #3498db;
            transform: translateY(-1px);
        }
        
        /* Subcategories */
        .subcategories {
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .subcategories h3 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 18px;
            margin-bottom: 15px;
        }
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .category-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            transition: all 0.3s;
        }
        .category-card:hover {
            background: #e9ecef;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .category-name {
            font-weight: 600;
            color: #2c3e50;
            text-decoration: none;
            display: block;
            margin-bottom: 5px;
        }
        .category-count {
            font-size: 14px;
            color: #6c757d;
        }
        .show-all-tags {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 16px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .show-all-tags:hover {
            background: #e9ecef;
        }
        .all-tags {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }
        .all-tags.visible {
            display: block;
        }
        
        /* Book Grid View */
        .books-grid {
            display: none;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .books-grid.active {
            display: grid;
        }
        .book-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        .book-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }
        .book-cover {
            width: 100%;
            height: 280px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 14px;
            position: relative;
            overflow: hidden;
        }
        .book-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .book-formats {
            position: absolute;
            bottom: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
        }
        .format-badge {
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            text-decoration: none;
        }
        .format-badge:hover {
            background: rgba(0,0,0,0.9);
        }
        .book-info {
            padding: 15px;
        }
        .book-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 15px;
            line-height: 1.4;
            height: 2.8em;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .book-author {
            color: #7f8c8d;
            font-size: 13px;
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .book-meta {
            font-size: 12px;
            color: #95a5a6;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .book-subjects {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
        }
        .subject-tag {
            font-size: 11px;
            background: #ecf0f1;
            color: #7f8c8d;
            padding: 2px 8px;
            border-radius: 3px;
        }
        
        /* List View */
        .books-list {
            display: none;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .books-list.active {
            display: block;
        }
        .book-list-item {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            gap: 20px;
            transition: background 0.3s;
        }
        .book-list-item:hover {
            background: #f8f9fa;
        }
        .book-list-cover {
            width: 80px;
            height: 120px;
            flex-shrink: 0;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #999;
            overflow: hidden;
        }
        .book-list-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .book-list-info {
            flex: 1;
        }
        .book-list-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        .book-list-author {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 10px;
        }
        .book-list-meta {
            font-size: 13px;
            color: #95a5a6;
            margin-bottom: 10px;
        }
        .book-list-description {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
            margin-bottom: 10px;
            max-height: 3em;
            overflow: hidden;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow-y: auto;
        }
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            max-width: 800px;
            border-radius: 8px;
            position: relative;
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            line-height: 1;
        }
        .modal-close:hover {
            color: #333;
        }
        .modal-header {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .modal-cover {
            width: 200px;
            height: 300px;
            flex-shrink: 0;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            overflow: hidden;
        }
        .modal-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .modal-info h2 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        .modal-info .author {
            font-size: 18px;
            color: #7f8c8d;
            margin-bottom: 15px;
        }
        .modal-section {
            margin-bottom: 20px;
        }
        .modal-section h3 {
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .download-links {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .download-btn {
            display: inline-block;
            padding: 10px 20px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background 0.3s;
        }
        .download-btn:hover {
            background: #2980b9;
        }
        .description {
            line-height: 1.6;
            color: #666;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .books-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }
            .modal-header {
                flex-direction: column;
            }
            .modal-cover {
                width: 100%;
                max-width: 200px;
                margin: 0 auto;
            }
        }
        
        /* No results */
        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        .no-results h3 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        /* Pagination */
        .pagination {
            margin: 40px 0;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        .page-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        .page-btn:hover:not(:disabled) {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .page-info {
            padding: 0 20px;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>{{ title }}</h1>
        <div class="stats">
            <span id="bookCount">{{ entries|length }}</span> books
            <span id="filteredCount" style="display: none;">‚Ä¢ Showing <span></span></span>
        </div>
        
        <div class="navigation">
            <a href="../index.html" class="tag">‚¨Ü Parent</a>
            <a href="#" onclick="navigateToRoot(); return false;" class="tag">üè† Root</a>
        </div>
        
        {% if child_tags %}
        <div class="subcategories">
            <h3>Subcategories ({{ child_tags|length }})</h3>
            {% if child_tags|length > 20 %}
                <div class="category-grid" id="topCategories">
                    {% for child_tag, count in child_tags.items()|sort(attribute='1', reverse=true) %}
                    {% if loop.index <= 20 %}
                    {% set tag_name = child_tag.split(tag_separator)[-1] %}
                    {% set safe_name = tag_name.replace('/', '-').replace('\\', '-') %}
                    <div class="category-card">
                        <a href="{{ safe_name }}/index.html" class="category-name">üìÅ {{ tag_name }}</a>
                        <div class="category-count">{{ count }} book{{'s' if count != 1 else ''}}</div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                <button class="show-all-tags" onclick="toggleAllTags()">
                    Show all {{ child_tags|length }} categories
                </button>
                <div class="all-tags" id="allTags">
                    <h4 style="margin-top: 0; color: #6c757d;">All categories (alphabetical):</h4>
                    <div class="category-grid">
                        {% for child_tag, count in child_tags.items()|sort %}
                        {% set tag_name = child_tag.split(tag_separator)[-1] %}
                        {% set safe_name = tag_name.replace('/', '-').replace('\\', '-') %}
                        <div class="category-card">
                            <a href="{{ safe_name }}/index.html" class="category-name">üìÅ {{ tag_name }}</a>
                            <div class="category-count">{{ count }} book{{'s' if count != 1 else ''}}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            {% else %}
                <div class="category-grid">
                    {% for child_tag, count in child_tags.items()|sort %}
                    {% set tag_name = child_tag.split(tag_separator)[-1] %}
                    {% set safe_name = tag_name.replace('/', '-').replace('\\', '-') %}
                    <div class="category-card">
                        <a href="{{ safe_name }}/index.html" class="category-name">üìÅ {{ tag_name }}</a>
                        <div class="category-count">{{ count }} book{{'s' if count != 1 else ''}}</div>
                    </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        {% endif %}
        
        <div class="controls">
            <input type="text" class="search-box" placeholder="Search books by title, author, subject..." id="searchBox">
            
            <div class="filters">
                <div class="filter-group">
                    <label>Language:</label>
                    <select class="filter-select" id="langFilter">
                        <option value="">All Languages</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Year:</label>
                    <select class="filter-select" id="yearFilter">
                        <option value="">All Years</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Format:</label>
                    <select class="filter-select" id="formatFilter">
                        <option value="">All Formats</option>
                    </select>
                </div>
            </div>
            
            <div class="view-toggle">
                <button class="view-btn active" onclick="setView('grid')">Grid View</button>
                <button class="view-btn" onclick="setView('list')">List View</button>
            </div>
        </div>
        
        <div id="booksContainer">
            <div class="books-grid active" id="gridView"></div>
            <div class="books-list" id="listView"></div>
            <div class="no-results" id="noResults" style="display: none;">
                <h3>No books found</h3>
                <p>Try adjusting your search or filters</p>
            </div>
        </div>
        
        <!-- Pagination controls -->
        <div class="pagination" id="pagination" style="display: none;">
            <button class="page-btn" onclick="goToPage(1)" id="firstPage">¬´ First</button>
            <button class="page-btn" onclick="previousPage()" id="prevPage">‚Äπ Previous</button>
            <span class="page-info">
                Page <span id="currentPageNum">1</span> of <span id="totalPageNum">1</span>
            </span>
            <button class="page-btn" onclick="nextPage()" id="nextPage">Next ‚Ä∫</button>
            <button class="page-btn" onclick="goToPage(totalPages)" id="lastPage">Last ¬ª</button>
        </div>
    </div>
    
    <!-- Modal for book details -->
    <div class="modal" id="bookModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>
    
    <script>
        // Book data
        const allBooks = {{ entries_json|safe }};
        let filteredBooks = [...allBooks];
        let currentView = 'grid';
        
        // Pagination settings
        const BOOKS_PER_PAGE = 50;
        let currentPage = 1;
        let totalPages = 1;
        
        // Path to _books directory based on template variable
        const isSubdir = {{ is_subdir|lower }};
        
        function getBooksPath() {
            return isSubdir ? '../_books/' : '_books/';
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeFilters();
            renderBooks();
            
            // Search functionality
            document.getElementById('searchBox').addEventListener('input', filterBooks);
            document.getElementById('langFilter').addEventListener('change', filterBooks);
            document.getElementById('yearFilter').addEventListener('change', filterBooks);
            document.getElementById('formatFilter').addEventListener('change', filterBooks);
        });
        
        function initializeFilters() {
            // Extract unique values for filters
            const languages = new Set();
            const years = new Set();
            const formats = new Set();
            
            allBooks.forEach(book => {
                if (book.language) languages.add(book.language);
                if (book.date) {
                    const year = new Date(book.date).getFullYear();
                    if (!isNaN(year)) years.add(year);
                }
                if (book.file_paths) {
                    book.file_paths.forEach(path => {
                        const ext = path.split('.').pop().toUpperCase();
                        formats.add(ext);
                    });
                }
            });
            
            // Populate language filter
            const langFilter = document.getElementById('langFilter');
            Array.from(languages).sort().forEach(lang => {
                const option = document.createElement('option');
                option.value = lang;
                option.textContent = lang;
                langFilter.appendChild(option);
            });
            
            // Populate year filter
            const yearFilter = document.getElementById('yearFilter');
            Array.from(years).sort((a, b) => b - a).forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });
            
            // Populate format filter
            const formatFilter = document.getElementById('formatFilter');
            Array.from(formats).sort().forEach(format => {
                const option = document.createElement('option');
                option.value = format;
                option.textContent = format;
                formatFilter.appendChild(option);
            });
        }
        
        function filterBooks() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const langFilter = document.getElementById('langFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            const formatFilter = document.getElementById('formatFilter').value;
            
            filteredBooks = allBooks.filter(book => {
                // Search filter
                if (searchTerm) {
                    const searchIn = [
                        book.title || '',
                        ...(book.creators || []),
                        ...(book.subjects || []),
                        book.description || ''
                    ].join(' ').toLowerCase();
                    
                    if (!searchIn.includes(searchTerm)) return false;
                }
                
                // Language filter
                if (langFilter && book.language !== langFilter) return false;
                
                // Year filter
                if (yearFilter && book.date) {
                    const bookYear = new Date(book.date).getFullYear();
                    if (bookYear != yearFilter) return false;
                }
                
                // Format filter
                if (formatFilter && book.file_paths) {
                    const hasFormat = book.file_paths.some(path => 
                        path.toUpperCase().endsWith('.' + formatFilter)
                    );
                    if (!hasFormat) return false;
                }
                
                return true;
            });
            
            // Reset to first page when filtering
            currentPage = 1;
            
            renderBooks();
            updateStats();
        }
        
        function updateStats() {
            const filteredSpan = document.getElementById('filteredCount');
            if (filteredBooks.length < allBooks.length) {
                filteredSpan.style.display = 'inline';
                const startIndex = (currentPage - 1) * BOOKS_PER_PAGE + 1;
                const endIndex = Math.min(currentPage * BOOKS_PER_PAGE, filteredBooks.length);
                if (totalPages > 1) {
                    filteredSpan.querySelector('span').textContent = 
                        `${startIndex}-${endIndex} of ${filteredBooks.length}`;
                } else {
                    filteredSpan.querySelector('span').textContent = filteredBooks.length;
                }
            } else if (totalPages > 1) {
                // Show pagination info even when not filtering
                filteredSpan.style.display = 'inline';
                const startIndex = (currentPage - 1) * BOOKS_PER_PAGE + 1;
                const endIndex = Math.min(currentPage * BOOKS_PER_PAGE, allBooks.length);
                filteredSpan.querySelector('span').textContent = 
                    `${startIndex}-${endIndex} of ${allBooks.length}`;
            } else {
                filteredSpan.style.display = 'none';
            }
        }
        
        function setView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase().includes(view));
            });
            document.getElementById('gridView').classList.toggle('active', view === 'grid');
            document.getElementById('listView').classList.toggle('active', view === 'list');
            renderBooks();
        }
        
        function renderBooks() {
            const noResults = document.getElementById('noResults');
            const pagination = document.getElementById('pagination');
            
            if (filteredBooks.length === 0) {
                document.getElementById('gridView').innerHTML = '';
                document.getElementById('listView').innerHTML = '';
                noResults.style.display = 'block';
                pagination.style.display = 'none';
                return;
            }
            
            noResults.style.display = 'none';
            
            // Calculate pagination
            totalPages = Math.ceil(filteredBooks.length / BOOKS_PER_PAGE);
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;
            
            // Get books for current page
            const startIndex = (currentPage - 1) * BOOKS_PER_PAGE;
            const endIndex = startIndex + BOOKS_PER_PAGE;
            const booksToShow = filteredBooks.slice(startIndex, endIndex);
            
            // Show/hide pagination
            if (totalPages > 1) {
                pagination.style.display = 'flex';
                updatePaginationControls();
            } else {
                pagination.style.display = 'none';
            }
            
            if (currentView === 'grid') {
                renderGridView(booksToShow);
            } else {
                renderListView(booksToShow);
            }
        }
        
        function renderGridView(booksToShow) {
            const grid = document.getElementById('gridView');
            grid.innerHTML = booksToShow.map(book => {
                const coverPath = book.cover_path || '';
                // For symlink DAG structure, covers are in _books/entry_id/
                const entryId = book._entry_id || book.unique_id;
                const booksPath = getBooksPath();
                const coverSrc = coverPath && entryId ? `${booksPath}${entryId}/${coverPath.split('/').pop()}` : '';
                const fileFormats = (book.file_paths || []).map(path => 
                    path.split('.').pop().toUpperCase()
                );
                
                return `
                    <div class="book-card" onclick="showBookDetails(${JSON.stringify(book).replace(/"/g, '&quot;')})">
                        <div class="book-cover">
                            ${coverSrc ? 
                                `<img src="${coverSrc}" alt="${book.title} cover" onerror="this.style.display='none'; this.parentElement.innerHTML='<div>No Cover</div>'">` :
                                '<div>No Cover</div>'
                            }
                            <div class="book-formats">
                                ${fileFormats.map(fmt => `<span class="format-badge">${fmt}</span>`).join('')}
                            </div>
                        </div>
                        <div class="book-info">
                            <div class="book-title" title="${book.title || 'Unknown Title'}">${book.title || 'Unknown Title'}</div>
                            <div class="book-author" title="${(book.creators || []).join(', ')}">by ${(book.creators || ['Unknown']).join(', ')}</div>
                            <div class="book-meta">
                                ${book.date ? `<span>${new Date(book.date).getFullYear()}</span>` : ''}
                                ${book.language ? `<span>${book.language}</span>` : ''}
                            </div>
                            ${book.subjects && book.subjects.length > 0 ? `
                                <div class="book-subjects">
                                    ${book.subjects.slice(0, 3).map(subj => 
                                        `<span class="subject-tag">${subj}</span>`
                                    ).join('')}
                                    ${book.subjects.length > 3 ? `<span class="subject-tag">+${book.subjects.length - 3}</span>` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderListView(booksToShow) {
            const list = document.getElementById('listView');
            list.innerHTML = booksToShow.map(book => {
                const coverPath = book.cover_path || '';
                // For symlink DAG structure, covers are in _books/entry_id/
                const entryId = book._entry_id || book.unique_id;
                const booksPath = getBooksPath();
                const coverSrc = coverPath && entryId ? `${booksPath}${entryId}/${coverPath.split('/').pop()}` : '';
                const description = book.description ? 
                    book.description.replace(/<[^>]*>/g, '').substring(0, 200) + '...' : '';
                
                return `
                    <div class="book-list-item" onclick="showBookDetails(${JSON.stringify(book).replace(/"/g, '&quot;')})">
                        <div class="book-list-cover">
                            ${coverSrc ? 
                                `<img src="${coverSrc}" alt="${book.title} cover" onerror="this.style.display='none'; this.parentElement.innerHTML='<div>No<br>Cover</div>'">` :
                                '<div>No<br>Cover</div>'
                            }
                        </div>
                        <div class="book-list-info">
                            <div class="book-list-title">${book.title || 'Unknown Title'}</div>
                            <div class="book-list-author">by ${(book.creators || ['Unknown']).join(', ')}</div>
                            <div class="book-list-meta">
                                ${book.date ? `${new Date(book.date).getFullYear()} ‚Ä¢ ` : ''}
                                ${book.language ? `${book.language} ‚Ä¢ ` : ''}
                                ${(book.file_paths || []).map(p => p.split('.').pop().toUpperCase()).join(', ')}
                            </div>
                            ${description ? `<div class="book-list-description">${description}</div>` : ''}
                            ${book.subjects && book.subjects.length > 0 ? `
                                <div class="book-subjects">
                                    ${book.subjects.map(subj => 
                                        `<span class="subject-tag">${subj}</span>`
                                    ).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function showBookDetails(book) {
            const modal = document.getElementById('bookModal');
            const content = document.getElementById('modalContent');
            
            const coverPath = book.cover_path || '';
            // For symlink DAG structure, covers are in _books/entry_id/
            const entryId = book._entry_id || book.unique_id;
            const booksPath = getBooksPath();
            const coverSrc = coverPath && entryId ? `${booksPath}${entryId}/${coverPath.split('/').pop()}` : '';
            
            // Get primary PDF and other files
            const files = book.file_paths || [];
            const pdfFile = files.find(f => f.toLowerCase().endsWith('.pdf'));
            const primaryFile = pdfFile || files[0];
            
            content.innerHTML = `
                <div class="modal-header">
                    <div class="modal-cover">
                        ${coverSrc ? 
                            `<img src="${coverSrc}" alt="${book.title} cover" onerror="this.style.display='none'; this.parentElement.innerHTML='<div>No Cover</div>'">` :
                            '<div>No Cover</div>'
                        }
                    </div>
                    <div class="modal-info">
                        <h2>${book.title || 'Unknown Title'}</h2>
                        <div class="author">by ${(book.creators || ['Unknown']).join(', ')}</div>
                        
                        <div class="modal-section">
                            <h3>Download</h3>
                            <div class="download-links">
                                ${primaryFile ? `<a href="${booksPath}${entryId}/${primaryFile.split('/').pop()}" class="download-btn">üìñ Open Primary (${primaryFile.split('.').pop().toUpperCase()})</a>` : ''}
                                ${files.filter(f => f !== primaryFile).map(file => 
                                    `<a href="${booksPath}${entryId}/${file.split('/').pop()}" class="download-btn">${file.split('.').pop().toUpperCase()}</a>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                </div>
                
                ${book.description ? `
                    <div class="modal-section">
                        <h3>Description</h3>
                        <div class="description">${book.description}</div>
                    </div>
                ` : ''}
                
                <div class="modal-section">
                    <h3>Details</h3>
                    <p>
                        ${book.date ? `<strong>Published:</strong> ${new Date(book.date).toLocaleDateString()}<br>` : ''}
                        ${book.language ? `<strong>Language:</strong> ${book.language}<br>` : ''}
                        ${book.identifiers ? Object.entries(book.identifiers).map(([key, value]) => 
                            `<strong>${key}:</strong> ${value}<br>`
                        ).join('') : ''}
                    </p>
                </div>
                
                ${book.subjects && book.subjects.length > 0 ? `
                    <div class="modal-section">
                        <h3>Subjects</h3>
                        <div class="book-subjects">
                            ${book.subjects.map(subj => 
                                `<span class="subject-tag">${subj}</span>`
                            ).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
            
            modal.style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('bookModal').style.display = 'none';
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('bookModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
        
        // Navigate to root
        function navigateToRoot() {
            let path = window.location.pathname;
            let depth = (path.match(/\//g) || []).length - 1;
            let rootPath = '../'.repeat(depth) + 'index.html';
            window.location.href = rootPath;
        }
        
        // Toggle all tags display
        function toggleAllTags() {
            const allTags = document.getElementById('allTags');
            const button = document.querySelector('.show-all-tags');
            
            if (allTags.classList.contains('visible')) {
                allTags.classList.remove('visible');
                button.textContent = `Show all ${button.textContent.match(/\d+/)[0]} categories`;
            } else {
                allTags.classList.add('visible');
                button.textContent = 'Show fewer categories';
            }
        }
        
        // Pagination functions
        function updatePaginationControls() {
            document.getElementById('currentPageNum').textContent = currentPage;
            document.getElementById('totalPageNum').textContent = totalPages;
            
            // Update button states
            document.getElementById('firstPage').disabled = currentPage === 1;
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
            document.getElementById('lastPage').disabled = currentPage === totalPages;
        }
        
        function goToPage(page) {
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderBooks();
                // Scroll to top
                window.scrollTo(0, 0);
            }
        }
        
        function previousPage() {
            if (currentPage > 1) {
                goToPage(currentPage - 1);
            }
        }
        
        function nextPage() {
            if (currentPage < totalPages) {
                goToPage(currentPage + 1);
            }
        }
    </script>
</body>
</html>